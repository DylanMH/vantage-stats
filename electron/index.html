<!DOCTYPE html>
<html>

<body style="background: #0b0f14; color: white; font-family: sans-serif; padding: 20px;">
    <div style="max-width: 500px; margin: 0 auto;">
        <h2 style="text-align: center; margin-bottom: 30px;">Vantage Stats Setup</h2>
        
        <div id="setup-content">
            <p id="status" style="margin-bottom: 20px;">Welcome! Let's get your stats tracking set up.</p>
            <p id="instructions" style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                Select your FPS trainer stats folder to begin.
            </p>
            
            <div id="folder-selection">
                <!-- Stats Folder -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; font-size: 13px;">Stats Folder</label>
                    <p style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">Where your FPS trainer saves performance stats (CSV files)</p>
                    <code id="chosen-stats" style="display: block; background: #1b2440; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; word-break: break-all; min-height: 20px;"></code>
                    <div style="display: flex; gap: 8px;">
                        <button id="pick-stats" style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px; flex: 1;">
                            Select Folder
                        </button>
                        <button id="use-default-stats" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            Use Default
                        </button>
                    </div>
                </div>
                
                <!-- Playlists Folder -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; font-size: 13px;">Playlists Folder (Optional)</label>
                    <p style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">Where your trainer saves downloaded playlists (JSON files)</p>
                    <code id="chosen-playlists" style="display: block; background: #1b2440; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; word-break: break-all; min-height: 20px;"></code>
                    <div style="display: flex; gap: 8px;">
                        <button id="pick-playlists" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px; flex: 1;">
                            Select Folder
                        </button>
                        <button id="use-default-playlists" style="background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            Use Default
                        </button>
                    </div>
                </div>

                <!-- Settings -->
                <div style="margin-bottom: 20px; padding: 15px; background: #1b2440; border-radius: 5px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: bold; font-size: 13px;">Auto-Generate Goals</div>
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">Automatically create improvement goals for your tasks</div>
                        </div>
                        <input type="checkbox" id="auto-goals" checked style="width: 18px; height: 18px; cursor: pointer;">
                    </label>
                    
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <div>
                            <div style="font-weight: bold; font-size: 13px;">Auto-Import Playlists</div>
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">Import playlists from folder as packs on startup</div>
                        </div>
                        <input type="checkbox" id="auto-import-playlists" style="width: 18px; height: 18px; cursor: pointer;">
                    </label>
                </div>
                
                <!-- Continue Button -->
                <button id="continue-setup" disabled style="background: #8b5cf6; color: white; border: none; padding: 14px 24px; border-radius: 5px; cursor: pointer; font-size: 15px; width: 100%; font-weight: bold; margin-top: 10px;">
                    Continue
                </button>
            </div>
            
            <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
                <div style="border: 3px solid #1b2440; border-top: 3px solid #2563eb; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p id="loading-title" style="margin-top: 20px; font-size: 16px; font-weight: bold;">Scanning CSV files...</p>
                <p id="loading-status" style="font-size: 13px; opacity: 0.8; margin-top: 8px;">This may take a moment on first launch</p>
                <p id="loading-substatus" style="font-size: 11px; opacity: 0.6; margin-top: 4px;">Importing performance data...</p>
            </div>
            
            <div id="error" style="display: none; background: #dc2626; color: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p id="error-message">Something went wrong. Please try again.</p>
                <button id="retry" style="background: #991b1b; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; margin-top: 10px;">
                    Retry
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');
        const fs = require('fs');
        const os = require('os');
        
        const statusEl = document.getElementById('status');
        const chosenStatsEl = document.getElementById('chosen-stats');
        const chosenPlaylistsEl = document.getElementById('chosen-playlists');
        const pickStatsBtn = document.getElementById('pick-stats');
        const pickPlaylistsBtn = document.getElementById('pick-playlists');
        const useDefaultStatsBtn = document.getElementById('use-default-stats');
        const useDefaultPlaylistsBtn = document.getElementById('use-default-playlists');
        const autoGoalsCheckbox = document.getElementById('auto-goals');
        const autoImportPlaylistsCheckbox = document.getElementById('auto-import-playlists');
        const continueBtn = document.getElementById('continue-setup');
        const loadingEl = document.getElementById('loading');
        const loadingStatusEl = document.getElementById('loading-status');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry');
        const folderSelectionEl = document.getElementById('folder-selection');
        
        let statsFolder = null;
        let playlistsFolder = null;

        // Detect default Steam paths
        function getDefaultStatsPath() {
            const steamPaths = [
                'C:\\Program Files (x86)\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\stats',
                'D:\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\stats',
                'C:\\Program Files\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\stats',
                path.join(os.homedir(), 'Steam', 'steamapps', 'common', 'FPSAimTrainer', 'FPSAimTrainer', 'stats')
            ];
            
            for (const steamPath of steamPaths) {
                if (fs.existsSync(steamPath)) {
                    return steamPath;
                }
            }
            return null;
        }

        function getDefaultPlaylistsPath() {
            const steamPaths = [
                'C:\\Program Files (x86)\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\Saved\\SaveGames\\Playlists',
                'D:\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\Saved\\SaveGames\\Playlists',
                'C:\\Program Files\\Steam\\steamapps\\common\\FPSAimTrainer\\FPSAimTrainer\\Saved\\SaveGames\\Playlists',
                path.join(os.homedir(), 'Steam', 'steamapps', 'common', 'FPSAimTrainer', 'FPSAimTrainer', 'Saved', 'SaveGames', 'Playlists')
            ];
            
            for (const steamPath of steamPaths) {
                if (fs.existsSync(steamPath)) {
                    return steamPath;
                }
            }
            return null;
        }

        function showError(message) {
            errorMessageEl.textContent = message;
            errorEl.style.display = 'block';
            loadingEl.style.display = 'none';
            folderSelectionEl.style.display = 'block';
        }

        function showLoading() {
            folderSelectionEl.style.display = 'none';
            errorEl.style.display = 'none';
            loadingEl.style.display = 'block';
        }

        // Stats folder picker
        pickStatsBtn.onclick = async () => {
            const folder = await ipcRenderer.invoke('pick-stats-folder');
            if (!folder) return;
            
            statsFolder = folder;
            chosenStatsEl.textContent = folder;
            
            // Enable continue button if stats folder is selected
            if (statsFolder) {
                continueBtn.disabled = false;
            }
        };

        // Use default stats path
        useDefaultStatsBtn.onclick = () => {
            const defaultPath = getDefaultStatsPath();
            if (defaultPath) {
                statsFolder = defaultPath;
                chosenStatsEl.textContent = defaultPath;
                continueBtn.disabled = false;
            } else {
                alert('Could not find default FPS trainer installation. Please select folder manually.');
            }
        };
        
        // Playlists folder picker (optional)
        pickPlaylistsBtn.onclick = async () => {
            const folder = await ipcRenderer.invoke('pick-stats-folder'); // Same picker
            if (!folder) return;
            
            playlistsFolder = folder;
            chosenPlaylistsEl.textContent = folder;
        };

        // Use default playlists path
        useDefaultPlaylistsBtn.onclick = () => {
            const defaultPath = getDefaultPlaylistsPath();
            if (defaultPath) {
                playlistsFolder = defaultPath;
                chosenPlaylistsEl.textContent = defaultPath;
            } else {
                alert('Could not find default playlists folder. Please select manually.');
            }
        };
        
        // Continue button - save config and start
        continueBtn.onclick = async () => {
            if (!statsFolder) {
                showError('Please select a stats folder first.');
                return;
            }
            
            continueBtn.disabled = true;
            continueBtn.textContent = 'Setting up...';
            showLoading();
            
            // Database always lives in userData directory
            const backendDbPath = path.join(__dirname, '../backend/vantage.db');
            
            const cfg = {
                stats_path: statsFolder,
                playlists_path: playlistsFolder || '', // Optional
                db_path: backendDbPath,
                port: 3000,
                auto_goals: autoGoalsCheckbox.checked,
                auto_import_playlists: autoImportPlaylistsCheckbox.checked
            };
            
            try {
                // Main process will handle CSV scanning and then auto-load dashboard
                await ipcRenderer.invoke('save-config', cfg);
                // Dashboard will load automatically when scan completes
            } catch (error) {
                showError('Setup failed: ' + error.message);
            }
        };

        retryBtn.onclick = () => {
            errorEl.style.display = 'none';
            folderSelectionEl.style.display = 'block';
            continueBtn.disabled = !statsFolder;
            continueBtn.textContent = 'Continue';
        };

        // Check if already configured on load
        (async () => {
            try {
                const config = await ipcRenderer.invoke('get-config');
                if (config && config.stats_path) {
                    // Config exists but we're in setup screen - main process should have loaded dashboard
                    // This means we're being shown due to an error, so just populate the form
                    statsFolder = config.stats_path;
                    playlistsFolder = config.playlists_path || null;
                    chosenStatsEl.textContent = statsFolder;
                    if (playlistsFolder) {
                        chosenPlaylistsEl.textContent = playlistsFolder;
                    }
                    continueBtn.disabled = false;
                }
            } catch (error) {
                console.error('Failed to check existing config:', error);
            }
        })();
    </script>
</body>

</html>